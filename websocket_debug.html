<!DOCTYPE html>
<html>
<head>
    <title>WebSocket Debug</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #f5f5f5; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        .log { background: #f8f9fa; border: 1px solid #ddd; padding: 10px; height: 400px; overflow-y: scroll; font-family: monospace; white-space: pre-wrap; }
        button { padding: 10px 20px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #0056b3; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç WebSocket Connection Debug</h1>
        <button onclick="testBasicWebSocket()">Test Basic WebSocket</button>
        <button onclick="testVNCProtocol()">Test VNC Protocol</button>
        <button onclick="clearLog()">Clear</button>
        <div class="log" id="log"></div>
    </div>

    <script>
        function log(msg) {
            document.getElementById('log').textContent += `[${new Date().toLocaleTimeString()}] ${msg}\n`;
            document.getElementById('log').scrollTop = document.getElementById('log').scrollHeight;
        }
        
        function testBasicWebSocket() {
            log('üîå Testing basic WebSocket connection...');
            
            const ws = new WebSocket(`ws://${location.host}/websockify`);
            
            ws.onopen = () => {
                log('‚úÖ WebSocket OPENED');
                log('ReadyState: ' + ws.readyState);
                log('Protocol: ' + ws.protocol);
                log('URL: ' + ws.url);
                
                // Send VNC protocol handshake
                setTimeout(() => {
                    log('üì§ Sending VNC protocol version...');
                    ws.send('RFB 003.008\\n');
                }, 1000);
                
                setTimeout(() => {
                    log('üîå Closing connection...');
                    ws.close();
                }, 3000);
            };
            
            ws.onmessage = (event) => {
                if (typeof event.data === 'string') {
                    log('üì® Received text: ' + event.data);
                } else {
                    log('üì® Received binary data: ' + event.data.byteLength + ' bytes');
                    // Convert first few bytes to hex
                    const view = new Uint8Array(event.data.slice(0, 20));
                    const hex = Array.from(view).map(b => b.toString(16).padStart(2, '0')).join(' ');
                    log('   Hex: ' + hex);
                }
            };
            
            ws.onerror = (error) => {
                log('‚ùå WebSocket ERROR: ' + error);
            };
            
            ws.onclose = (event) => {
                log(`üîå WebSocket CLOSED: ${event.code} - ${event.reason || 'No reason'}`);
                log('Was clean: ' + event.wasClean);
            };
        }
        
        async function testVNCProtocol() {
            log('üñ•Ô∏è Testing VNC protocol connection...');
            
            try {
                const { default: RFB } = await import('./core/rfb.js');
                log('‚úÖ RFB module loaded successfully');
                
                // Create container
                const container = document.createElement('div');
                container.style.width = '640px';
                container.style.height = '480px';
                container.style.border = '1px solid #ccc';
                container.style.margin = '10px 0';
                document.querySelector('.container').appendChild(container);
                
                const wsUrl = `ws://${location.host}/websockify`;
                log('üîó Creating RFB connection to: ' + wsUrl);
                
                const rfb = new RFB(container, wsUrl, {
                    credentials: {},
                    focusOnClick: true,
                    clipViewport: false,
                    scaleViewport: true,
                    resizeSession: false,
                    viewOnly: false
                });
                
                rfb.addEventListener('connect', () => {
                    log('üéâ VNC CONNECTED successfully!');
                });
                
                rfb.addEventListener('disconnect', (e) => {
                    log('üíî VNC DISCONNECTED: ' + JSON.stringify(e.detail));
                });
                
                rfb.addEventListener('securityfailure', (e) => {
                    log('üîí Security failure: ' + JSON.stringify(e.detail));
                });
                
                log('‚è≥ Waiting for VNC connection...');
                
            } catch (error) {
                log('‚ùå Failed to load RFB: ' + error.message);
            }
        }
        
        function clearLog() {
            document.getElementById('log').textContent = '';
        }
        
        log('üöÄ WebSocket debug tool ready');
    </script>
</body>
</html>
